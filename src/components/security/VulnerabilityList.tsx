/**
 * Vulnerability List Component
 * Displays a filterable, searchable table of vulnerabilities with AI analysis
 * @see specs/005-package-security-audit/spec.md
 */

import { useState, useMemo, useCallback } from 'react';
import {
  Search,
  Filter,
  X,
  Package,
  AlertCircle,
  AlertTriangle,
  Sparkles,
  ExternalLink,
} from 'lucide-react';
import type { VulnItem, VulnSeverity, SeverityFilterState, VulnSummary } from '../../types/security';
import { VulnerabilityDetailDialog } from './VulnerabilityDetailDialog';
import { SeverityBadge } from './SeverityBadge';
import { Button } from '../ui/Button';
import { cn } from '../../lib/utils';
import { openUrl } from '../../lib/tauri-api';

interface VulnerabilityListProps {
  /** List of vulnerabilities to display */
  vulnerabilities: VulnItem[];
  /** Vulnerability summary for AI analysis */
  summary?: VulnSummary;
  /** Additional CSS classes */
  className?: string;
  /** Whether AI analysis is available (configured and has project path) */
  aiEnabled?: boolean;
  /** Whether AI service is configured (has default service) */
  aiConfigured?: boolean;
  /** Whether any AI analysis is in progress */
  isAIGenerating?: boolean;
  /** ID of vulnerability currently being analyzed (null for summary mode) */
  activeAIVulnerabilityId?: string | null;
  /** Whether summary analysis is active */
  isAISummaryActive?: boolean;
  /** AI error message to display */
  aiError?: string | null;
  /** Callback to analyze a single vulnerability */
  onAnalyzeVulnerability?: (vulnerability: VulnItem) => void;
  /** Callback to analyze all vulnerabilities */
  onAnalyzeAll?: () => void;
  /** Callback to open AI settings when AI is not configured */
  onOpenAISettings?: () => void;
  /** Callback to clear AI error */
  onClearAIError?: () => void;
}

/** Default filter state - all severities visible */
const defaultFilterState: SeverityFilterState = {
  critical: true,
  high: true,
  moderate: true,
  low: true,
  info: true,
};

/** Severity order for sorting */
const severityOrder: Record<VulnSeverity, number> = {
  critical: 0,
  high: 1,
  moderate: 2,
  low: 3,
  info: 4,
};

/**
 * Filterable and searchable vulnerability table with AI analysis
 */
export function VulnerabilityList({
  vulnerabilities,
  summary: _summary,
  className,
  aiEnabled = false,
  aiConfigured = false,
  isAIGenerating = false,
  activeAIVulnerabilityId = null,
  isAISummaryActive = false,
  aiError = null,
  onAnalyzeVulnerability,
  onAnalyzeAll,
  onOpenAISettings,
  onClearAIError,
}: VulnerabilityListProps) {
  // State
  const [searchQuery, setSearchQuery] = useState('');
  const [severityFilter, setSeverityFilter] = useState<SeverityFilterState>(defaultFilterState);
  const [showFilterPanel, setShowFilterPanel] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<VulnItem | null>(null);

  // Calculate severity counts
  const severityCounts = useMemo(() => {
    return vulnerabilities.reduce(
      (acc, vuln) => {
        acc[vuln.severity]++;
        return acc;
      },
      { critical: 0, high: 0, moderate: 0, low: 0, info: 0 } as Record<VulnSeverity, number>
    );
  }, [vulnerabilities]);

  // Filter and sort vulnerabilities
  const filteredVulnerabilities = useMemo(() => {
    return vulnerabilities
      .filter((vuln) => {
        // Severity filter
        if (!severityFilter[vuln.severity]) return false;

        // Search filter
        if (searchQuery.trim()) {
          const query = searchQuery.toLowerCase();
          return (
            vuln.packageName.toLowerCase().includes(query) ||
            vuln.title.toLowerCase().includes(query) ||
            vuln.id.toLowerCase().includes(query) ||
            vuln.cves.some((cve) => cve.toLowerCase().includes(query))
          );
        }

        return true;
      })
      .sort((a, b) => {
        // Sort by severity (critical first)
        const severityDiff = severityOrder[a.severity] - severityOrder[b.severity];
        if (severityDiff !== 0) return severityDiff;

        // Then by direct dependency status
        if (a.isDirect !== b.isDirect) return a.isDirect ? -1 : 1;

        // Then alphabetically by package name
        return a.packageName.localeCompare(b.packageName);
      });
  }, [vulnerabilities, severityFilter, searchQuery]);

  // Toggle severity filter
  const toggleSeverity = useCallback((severity: VulnSeverity) => {
    setSeverityFilter((prev) => ({
      ...prev,
      [severity]: !prev[severity],
    }));
  }, []);

  // Reset filters
  const resetFilters = useCallback(() => {
    setSearchQuery('');
    setSeverityFilter(defaultFilterState);
  }, []);

  // Open vulnerability detail dialog
  const handleOpenDetail = useCallback((vuln: VulnItem) => {
    setSelectedVulnerability(vuln);
  }, []);

  // Check if any filter is active
  const hasActiveFilter =
    searchQuery.trim() !== '' ||
    Object.values(severityFilter).some((v) => !v);

  // Empty state
  if (vulnerabilities.length === 0) {
    return (
      <div className={cn('flex flex-col items-center justify-center py-12 text-center', className)}>
        <div className="p-4 bg-green-500/10 rounded-full mb-4">
          <Package className="w-8 h-8 text-green-400" aria-hidden="true" />
        </div>
        <h3 className="text-lg font-medium text-foreground mb-2">No Vulnerabilities Found</h3>
        <p className="text-sm text-muted-foreground max-w-sm">
          Your project dependencies are secure. Keep your packages updated to maintain security.
        </p>
      </div>
    );
  }

  return (
    <div className={cn('space-y-4', className)}>
      {/* AI Analysis Bar */}
      {(aiEnabled || (!aiConfigured && onOpenAISettings)) && (
        <div className="flex items-center justify-between p-3 bg-amber-500/5 border border-amber-500/20 rounded-lg">
          <div className="flex items-center gap-2">
            <Sparkles className="w-4 h-4 text-amber-400" />
            <span className="text-sm text-foreground">
              AI Security Analysis
            </span>
            <span className="text-xs text-muted-foreground">
              ({vulnerabilities.length} vulnerabilities)
            </span>
          </div>
          {aiEnabled && onAnalyzeAll ? (
            <Button
              variant="ghost"
              onClick={onAnalyzeAll}
              disabled={isAIGenerating}
              className={cn(
                'group relative flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium h-auto',
                'bg-amber-600/20 hover:bg-amber-600/30 text-amber-300',
                'border border-amber-500/30 transition-all duration-200',
                isAISummaryActive && 'animate-ai-security-glow'
              )}
            >
              <Sparkles
                className={cn(
                  'w-3.5 h-3.5 text-amber-400 transition-transform duration-200',
                  isAISummaryActive ? 'animate-security-sparkle' : 'group-hover:scale-110'
                )}
              />
              {isAISummaryActive ? 'Analyzing...' : 'Analyze All'}
            </Button>
          ) : onOpenAISettings ? (
            <Button
              variant="outline"
              onClick={onOpenAISettings}
              className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium h-auto"
            >
              <Sparkles className="w-3.5 h-3.5" />
              Configure AI
            </Button>
          ) : null}
        </div>
      )}

      {/* AI Error Display */}
      {aiError && (
        <div className="flex items-center justify-between p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
          <div className="flex items-center gap-2">
            <AlertTriangle className="w-4 h-4 text-red-400" />
            <span className="text-sm text-red-400">{aiError}</span>
          </div>
          {onClearAIError && (
            <Button
              variant="ghost"
              size="icon"
              onClick={onClearAIError}
              className="h-6 w-6 text-red-400 hover:text-red-300 hover:bg-red-500/20"
            >
              <X className="w-3.5 h-3.5" />
            </Button>
          )}
        </div>
      )}

      {/* Search, Filter, and Controls Bar */}
      <div className="flex items-center gap-2">
        {/* Search Input */}
        <div className="relative flex-1">
          <Search
            className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"
            aria-hidden="true"
          />
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search by package, title, or CVE..."
            autoComplete="off"
            autoCorrect="off"
            autoCapitalize="off"
            spellCheck={false}
            className={cn(
              'w-full pl-9 pr-8 py-2',
              'bg-secondary border border-border rounded-lg',
              'text-sm text-foreground placeholder-muted-foreground',
              'focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30'
            )}
            aria-label="Search vulnerabilities"
          />
          {searchQuery && (
            <Button
              variant="ghost"
              size="icon"
              onClick={() => setSearchQuery('')}
              className="absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6"
              aria-label="Clear search"
            >
              <X className="w-4 h-4" />
            </Button>
          )}
        </div>

        {/* Filter Toggle Button */}
        <Button
          variant="outline"
          onClick={() => setShowFilterPanel(!showFilterPanel)}
          className={cn(
            'flex items-center gap-1.5 px-3 py-2 h-auto',
            showFilterPanel || hasActiveFilter
              ? 'bg-blue-500/20 border-blue-500/50 text-blue-400'
              : 'bg-secondary border-border text-muted-foreground hover:text-foreground'
          )}
          aria-expanded={showFilterPanel}
          aria-controls="filter-panel"
        >
          <Filter className="w-4 h-4" aria-hidden="true" />
          <span>Filter</span>
        </Button>

        {/* Reset Filters */}
        {hasActiveFilter && (
          <Button
            variant="ghost"
            onClick={resetFilters}
            className="px-3 py-2 text-sm text-muted-foreground hover:text-foreground h-auto"
          >
            Reset
          </Button>
        )}

        {/* Shown Count */}
        <span className="text-sm text-muted-foreground whitespace-nowrap">
          {filteredVulnerabilities.length} of {vulnerabilities.length}
        </span>
      </div>

      {/* Filter Panel */}
      {showFilterPanel && (
        <div
          id="filter-panel"
          className="p-3 bg-card border border-border rounded-lg"
        >
          <h4 className="text-sm font-medium text-foreground mb-3">Filter by Severity</h4>
          <div className="flex flex-wrap gap-2">
            {(['critical', 'high', 'moderate', 'low', 'info'] as VulnSeverity[]).map((severity) => (
              <Button
                key={severity}
                variant="ghost"
                onClick={() => toggleSeverity(severity)}
                className={cn(
                  'h-auto p-0',
                  !severityFilter[severity] && 'opacity-40'
                )}
                aria-pressed={severityFilter[severity]}
              >
                <SeverityBadge
                  severity={severity}
                  count={severityCounts[severity]}
                  showIcon
                />
              </Button>
            ))}
          </div>
        </div>
      )}

      {/* Vulnerability Table */}
      {filteredVulnerabilities.length > 0 ? (
        <div className="border border-border rounded-lg overflow-hidden">
          {/* Table Header */}
          <div className="grid grid-cols-[80px_180px_1fr_100px_100px_100px] gap-2 px-3 py-2 bg-muted/50 border-b border-border text-xs font-medium text-muted-foreground uppercase tracking-wider">
            <div>Severity</div>
            <div>Package</div>
            <div>Title</div>
            <div>CVE</div>
            <div>Status</div>
            <div className="text-right">Actions</div>
          </div>

          {/* Table Body */}
          <div role="list" aria-label="Vulnerability list">
            {filteredVulnerabilities.map((vuln) => (
              <VulnerabilityTableRow
                key={vuln.id}
                vulnerability={vuln}
                onOpenDetail={() => handleOpenDetail(vuln)}
                aiEnabled={aiEnabled}
                isAIGenerating={isAIGenerating}
                isThisAnalyzing={activeAIVulnerabilityId === vuln.id}
                onAnalyze={onAnalyzeVulnerability}
              />
            ))}
          </div>
        </div>
      ) : (
        <div className="flex flex-col items-center justify-center py-8 text-center">
          <AlertCircle className="w-8 h-8 text-muted-foreground mb-3" aria-hidden="true" />
          <h3 className="text-base font-medium text-foreground mb-1">No Matching Vulnerabilities</h3>
          <p className="text-sm text-muted-foreground">
            Try adjusting your search query or filters
          </p>
          <Button
            variant="link"
            onClick={resetFilters}
            className="mt-3 text-sm text-blue-400 hover:text-blue-300"
          >
            Clear all filters
          </Button>
        </div>
      )}

      {/* Vulnerability Detail Dialog */}
      <VulnerabilityDetailDialog
        open={selectedVulnerability !== null}
        onOpenChange={(open) => !open && setSelectedVulnerability(null)}
        vulnerability={selectedVulnerability}
        aiEnabled={aiEnabled}
        aiConfigured={aiConfigured}
        isAIGenerating={isAIGenerating}
        isThisAnalyzing={selectedVulnerability ? activeAIVulnerabilityId === selectedVulnerability.id : false}
        onAnalyze={onAnalyzeVulnerability}
        onOpenAISettings={onOpenAISettings}
      />
    </div>
  );
}

/**
 * Table row for a single vulnerability
 */
interface VulnerabilityTableRowProps {
  vulnerability: VulnItem;
  onOpenDetail: () => void;
  aiEnabled?: boolean;
  isAIGenerating?: boolean;
  isThisAnalyzing?: boolean;
  onAnalyze?: (vulnerability: VulnItem) => void;
}

function VulnerabilityTableRow({
  vulnerability,
  onOpenDetail,
  aiEnabled = false,
  isAIGenerating = false,
  isThisAnalyzing = false,
  onAnalyze,
}: VulnerabilityTableRowProps) {
  const { packageName, installedVersion, severity, title, cves, fixAvailable, advisoryUrl } = vulnerability;

  return (
    <div
      className={cn(
        'border-b border-border last:border-b-0 transition-colors cursor-pointer',
        'bg-background hover:bg-muted/30'
      )}
      onClick={onOpenDetail}
      role="button"
      tabIndex={0}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          onOpenDetail();
        }
      }}
    >
      {/* Row */}
      <div className="grid grid-cols-[80px_180px_1fr_100px_100px_100px] gap-2 px-3 py-2.5 items-center">
        {/* Severity */}
        <div>
          <SeverityBadge severity={severity} showIcon compact />
        </div>

        {/* Package */}
        <div className="min-w-0">
          <span className="text-sm font-mono text-foreground truncate block">
            {packageName}
          </span>
          <span className="text-xs text-muted-foreground font-mono">
            @{installedVersion}
          </span>
        </div>

        {/* Title */}
        <div className="min-w-0">
          <span className="text-sm text-foreground truncate block hover:text-blue-400 transition-colors">
            {title}
          </span>
        </div>

        {/* CVE */}
        <div className="text-xs">
          {cves.length > 0 ? (
            <button
              onClick={(e) => {
                e.stopPropagation();
                openUrl(`https://nvd.nist.gov/vuln/detail/${cves[0]}`);
              }}
              className="text-muted-foreground hover:text-blue-400 font-mono transition-colors"
            >
              {cves[0]}
            </button>
          ) : (
            <span className="text-muted-foreground">-</span>
          )}
        </div>

        {/* Status */}
        <div>
          {fixAvailable ? (
            <span className="inline-flex items-center px-1.5 py-0.5 text-xs bg-green-500/20 text-green-400 rounded">
              Fix Available
            </span>
          ) : (
            <span className="text-xs text-muted-foreground">No fix</span>
          )}
        </div>

        {/* Actions */}
        <div className="flex items-center justify-end gap-1">
          {advisoryUrl && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                openUrl(advisoryUrl);
              }}
              className="p-1.5 text-muted-foreground hover:text-blue-400 rounded transition-colors"
              title="View Advisory"
            >
              <ExternalLink className="w-3.5 h-3.5" />
            </button>
          )}
          {aiEnabled && onAnalyze && (
            <Button
              variant="ghost"
              size="icon"
              onClick={(e) => {
                e.stopPropagation();
                onAnalyze(vulnerability);
              }}
              disabled={isAIGenerating}
              className={cn(
                'group h-7 w-7 transition-all duration-200',
                'border border-transparent',
                isThisAnalyzing
                  ? 'text-amber-400 bg-amber-500/20 border-amber-500/30 animate-ai-security-glow'
                  : 'text-muted-foreground hover:text-amber-400 hover:bg-amber-500/10 hover:border-amber-500/30'
              )}
              title="AI Analysis"
            >
              <Sparkles
                className={cn(
                  'w-3.5 h-3.5 transition-transform duration-200',
                  isThisAnalyzing ? 'animate-security-sparkle text-amber-400' : 'group-hover:scale-110'
                )}
              />
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}

/**
 * Compact vulnerability list for overview displays
 */
interface CompactVulnerabilityListProps {
  vulnerabilities: VulnItem[];
  maxItems?: number;
  onViewAll?: () => void;
  className?: string;
}

export function CompactVulnerabilityList({
  vulnerabilities,
  maxItems = 5,
  onViewAll,
  className,
}: CompactVulnerabilityListProps) {
  // Sort by severity and take top items
  const topVulnerabilities = useMemo(() => {
    return [...vulnerabilities]
      .sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity])
      .slice(0, maxItems);
  }, [vulnerabilities, maxItems]);

  if (vulnerabilities.length === 0) {
    return (
      <div className={cn('text-sm text-muted-foreground text-center py-4', className)}>
        No vulnerabilities found
      </div>
    );
  }

  return (
    <div className={cn('space-y-2', className)}>
      {topVulnerabilities.map((vuln) => (
        <div
          key={vuln.id}
          className="flex items-center gap-2 p-2 bg-muted rounded"
        >
          <SeverityBadge severity={vuln.severity} compact showIcon={false} />
          <div className="flex-1 min-w-0">
            <p className="text-sm text-foreground truncate">{vuln.title}</p>
            <p className="text-xs text-muted-foreground font-mono truncate">
              {vuln.packageName}@{vuln.installedVersion}
            </p>
          </div>
        </div>
      ))}
      {vulnerabilities.length > maxItems && onViewAll && (
        <Button
          variant="link"
          onClick={onViewAll}
          className="w-full py-2 text-sm text-blue-400 hover:text-blue-300 text-center"
        >
          View all {vulnerabilities.length} vulnerabilities
        </Button>
      )}
    </div>
  );
}
